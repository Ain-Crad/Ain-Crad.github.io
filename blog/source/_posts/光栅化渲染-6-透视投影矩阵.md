---
title: 光栅化渲染-6-透视投影矩阵
date: 2019-09-20 21:29:19
categories:
- Computer Graphics
- 光栅化渲染
tags:
---

　　*GPU结构被设计的非常适合矩阵运算，把透视投影过程用矩阵表达出来可以加速计算。*

# Unit Cube
　　在讨论如何构造透视投影矩阵之前，我们先了解透视投影的作用（效果）。空间中一点 $P$ 乘以透视投影矩阵后，我们会得到一点 $P^\prime$：
``
　　它的 x' 坐标和 y' 坐标的范围是 [-1, 1]，即定义在 NDC 空间下。
　　它的 z' 坐标的范围同样被压缩到 [-1, 1] 的范围内，边界分别为近剪切平面和远剪切平面。
``

　　如（Figure 1）所示，这样做的效果从空间中来看，其实是把相机坐标系下的**视棱台**(viewing frustum)压缩成了**立方体**(unit cube)。

![figure1](/figure1.png)
<center>Figure 1</center>

　　而这样做的目的是为了方便做**剪切(clipping)**。一方面去除那些在视野范围之外的图元（不必浪费资源渲染它们），另一方面对那些一部分在视野内一部分在视野外的图元做修剪（Figure 2）。

![figure2](/figure2.png)
<center>Figure 2</center>

``这里有一个剪切空间(Clip Space)的概念，与 NDC 空间不同。我们稍后再做介绍 。``

# 透视投影矩阵
　　现在我们可以开始构造透视投影矩阵了。回顾一下之前的透视投影的内容，相机空间中的点投影到成像平面上（Figure 3）的变化为：

![figure 3](/figure3.png)
<center>Figure 3</center>

$$
P_(S_x) = \cfrac{n * P_x}{-P_z}
P_(S_y) = \cfrac{n * P_y}{-P_z}
$$

　　我们发现计算投影要除以 $P_z$ 坐标，但这是矩阵的线性变换做不到的，矩阵只能线性的组合 $P_x, P_y, P_z$ 来得到 $P_{S_x}, P_{S_y}, P_{S_z}$，于是我们引入**其次坐标**，将空间点扩充为 $(P_x, P_y, P_z, P_w = 1)$。
　　同时对矩阵做特定设定，使其将转换后的 $P_{S_w}$ 分量设置为 $-P_z$，这样通过 $[P_{S_x}, P_{S_y}, P_{S_z}, P_{S_w}]$ 整体除以 $P_{S_w}$ 分量便实现了除法变换。

$$
\left[
    \begin{matrix}
        ... & ... & ... & ... \\\\
        ... & ... & ... & ... \\\\
        ... & ... & ... & ... \\\\
        0 & 0 & -1 & 0
    \end{matrix}
\right]
\*
\left[
    \begin{matrix}
        P_x \\\\
        P_y \\\\
        P_z \\\\
        1
    \end{matrix}
\right]
= 
\left[
    \begin{matrix}
        P_{S_x} \\\\
        P_{S_y} \\\\
        P_{S_z} \\\\
        -P_z
    \end{matrix}
\right]
$$

　　接下来继续构造其它分量，假设成像平面坐标系的 $x$ 坐标范围为 $[l, r]$，$y$ 坐标范围为 $[b, t]$，近平面和远平面分别为 $n, f$。
　　由[透视投影的拓展内容](https://ain-crad.github.io/2019/08/11/%E5%85%89%E6%A0%85%E5%8C%96%E6%B8%B2%E6%9F%93-2-%E9%80%8F%E8%A7%86%E6%8A%95%E5%BD%B1/#more)中我们知道，若要使相机坐标 $P_x$ 变换到屏幕坐标 $P_{S_x}$ 且范围为 $[-1, 1]$，那么

$$
P_{S_x} = \cfrac{2nP_x}{-P_z(r-l)}-\cfrac{r+l}{r-l}
$$

　　由于 $\cfrac{1}{-P_z}$ 部分可以除以 $P_{S_w}$ 分量得到，所以目前的矩阵形式为：

$$
\left[
    \begin{matrix}
        \cfrac{2n}{r-l} & 0 & \cfrac{r+l}{r-l} & 0 \\\\
        ... & ... & ... & ... \\\\
        ... & ... & ... & ... \\\\
        0 & 0 & -1 & 0
    \end{matrix}
\right]
$$

　　同理

$$
P_{S_y} = \cfrac{2nP_y}{t-b}-\cfrac{t+b}{t-b}
$$

　　进一步扩充矩阵

$$
\left[
    \begin{matrix}
        \cfrac{2n}{r-l} & 0 & \cfrac{r+l}{r-l} & 0 \\\\
        0 & \cfrac{2n}{t-b} & \cfrac{t+b}{t-b} & 0 \\\\
        ... & ... & ... & ... \\\\
        0 & 0 & -1 & 0
    \end{matrix}
\right]
$$